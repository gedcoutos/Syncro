<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Estoque - Syncro!</title>
    <link rel="shortcut icon" href="/images/logo_topo.png" type="image/x-icon">

    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <!-- √çcones Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
</head>

<body class="bg-primary">

<nav class="navbar d-md-none navbar-dark px-3">
    <button class="btn btn-outline-light d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuMobile">‚ò∞</button>
    <span class="navbar-brand">
        <img src="/images/logo.png" alt="Logo Syncro!" style="height: 40px;">
    </span>
</nav>

<!-- MENU DESKTOP -->
<aside class="sidebar-fixed d-none d-md-flex flex-column justify-content-between bg-white border-end p-3">
    <div>
        <br>
        <div class="d-flex justify-content-center">
            <img src="/images/logo.png" alt="Logo Syncro!" style="height: 40px;">
        </div>
        <br>
        <ul class="nav nav-pills flex-column gap-1 mt-4">
            <li class="nav-item"><a class="nav-link" th:href="@{/home}">Home</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/veiculos/registro}">Cadastrar Ve√≠culo</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/pecas/cadastrar}">Cadastrar Pe√ßas</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/consulta-placa}">Consulta por Placa</a></li>
            <li class="nav-item"><a class="nav-link active" th:href="@{/pecas/estoque/consulta}">Consultar Estoque</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/estoque/visualizar}">Visualizar Boxes</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/funcionarios/novo}">Cadastrar Funcion√°rio</a></li>
        </ul>
    </div>


    <div class="border-top small d-flex align-items-center justify-content-between px-2 pt-2 mt-3">
        <div class="me-2">
            <div class="fw-semibold">
                <span class="me-1">üë§</span>
                <span th:text="${session.nomeExibicao} ?: ${session.usuarioLogado}">Usu√°rio</span>
            </div>
        </div>
        <a th:href="@{/logout}" class="btn btn-sm btn-outline-danger">Sair</a>
    </div>
</aside>

<!-- MENU MOBILE -->
<aside class="offcanvas offcanvas-start" tabindex="-1" id="menuMobile">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>

    <div class="offcanvas-body d-flex flex-column h-100">
        <ul class="nav nav-pills flex-column gap-1">
            <li class="nav-item"><a class="nav-link" th:href="@{/home}">Home</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/veiculos/registro}">Cadastrar Ve√≠culo</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/pecas/cadastrar}">Cadastrar Pe√ßas</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/consulta-placa}">Consulta por Placa</a></li>
            <li class="nav-item"><a class="nav-link active" th:href="@{/pecas/estoque/consulta}">Consultar Estoque</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/estoque/visualizar}">Visualizar Boxes</a></li>
            <li class="nav-item"><a class="nav-link" th:href="@{/funcionarios/novo}">Cadastrar Funcion√°rio</a></li>
        </ul>

        <div class="mt-auto pt-3 border-top small">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <div class="fw-semibold">
                        <span class="me-1">üë§</span>
                        <span th:text="${session.nomeExibicao} ?: ${session.usuarioLogado}">Usu√°rio</span>
                    </div>
                </div>
                <a th:href="@{/logout}" class="btn btn-sm btn-outline-danger">Sair</a>
            </div>
        </div>
    </div>
</aside>

<main class="content-wrap p-3">

    <!-- DESKTOP -->
    <section class="d-none d-xl-block">
        <div class="container-fluid">
            <div class="card shadow-lg bg-light p-4">

                <h2 class="mb-2">Consultar Estoque da Oficina</h2>

                <!-- Alerts -->
                <div th:if="${ok}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${ok}">OK</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
                <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${erro}">Erro</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>


                <hr>

                <!-- Filtros -->
                <form th:action="@{/pecas/estoque/consulta/buscar}" method="get" class="row g-2">
                    <div class="col-12 col-md-4">
                        <label class="form-label">Descri√ß√£o</label>
                        <input class="form-control" name="descricao" placeholder="ex: para-choque" th:value="${descricao}">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Montadora</label>
                        <input class="form-control" name="montadora" placeholder="ex: GM" th:value="${montadora}">
                    </div>
                    <div class="col-6 col-md-3">
                        <label class="form-label">Modelo</label>
                        <input class="form-control" name="modelo" placeholder="ex: Onix" th:value="${modelo}">
                    </div>
                    <div class="col-6 col-md-2">
                        <label class="form-label">Ano</label>
                        <input class="form-control" type="number" name="ano" th:value="${ano}">
                    </div>
                    <div class="col-12 d-flex gap-2 mt-3">
                        <button class="btn btn-primary mt-2" type="submit">Buscar</button>
                        <a class="btn btn-outline-secondary mt-2" th:href="@{/pecas/estoque/consulta}">Limpar</a>
                    </div>
                </form>

                <!-- Resultados -->
                <div class="table-responsive mt-4" th:if="${resultados != null}">
                    <table class="table table-striped align-middle">
                        <thead class="thead-syncro">
                        <tr>
                            <th>Pe√ßa</th>
                            <th>Montadora</th>
                            <th>Modelo</th>
                            <th>Ano</th>
                            <th>Box</th>
                            <th class="text-center">  </th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${#lists.isEmpty(resultados)}">
                            <td colspan="6" class="text-muted text-center">Nenhuma pe√ßa encontrada.</td>
                        </tr>
                        <tr th:each="p : ${resultados}">
                            <td th:text="${p.subdescricao != null ? p.subdescricao : p.descricao}">‚Äî</td>
                            <td th:text="${p.montadora}">‚Äî</td>
                            <td th:text="${p.modelo}">‚Äî</td>
                            <td th:text="${p.ano}">‚Äî</td>
                            <td th:text="${p.subbox != null ? p.subbox : '-'}">‚Äî</td>
                            <td class="text-center">

                                <a href="#"
                                   class="btn btn-outline-success btn-sm me-2"
                                   data-bs-toggle="modal"
                                   data-bs-target="#modalVincular"
                                   th:attr="data-id=${p.idPeca}, data-nome=${p.subdescricao != null ? p.subdescricao : p.descricao}">
                                    <i class="bi bi-link-45deg"></i> Vincular
                                </a>

                                <a th:href="@{'/pecas/excluir/' + ${p.idPeca}}"
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Tem certeza que deseja excluir esta pe√ßa?');"
                                   title="Excluir pe√ßa">
                                    <i class="bi bi-trash"></i> Excluir
                                </a>

                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </section>


    <!-- MOBILE -->
    <section class="d-flex flex-column justify-content-center align-items-center pt-4 d-block d-xl-none">
        <div class="container-fluid">
            <div class="card shadow-lg bg-light p-4 w-100">

                <h2 class="mb-3">Consultar Estoque da Oficina</h2>

                <!-- Alerts -->
                <div th:if="${ok}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${ok}">OK</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>
                <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${erro}">Erro</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                </div>


                <!-- FILTROS (mobile) -->
                <form th:action="@{/pecas/estoque/consulta/buscar}" method="get" class="row g-2">
                    <div class="col-12">
                        <label class="form-label">Descri√ß√£o</label>
                        <input class="form-control" name="descricao" placeholder="ex: para-choque" th:value="${descricao}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Montadora</label>
                        <input class="form-control" name="montadora" placeholder="ex: GM" th:value="${montadora}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Modelo</label>
                        <input class="form-control" name="modelo" placeholder="ex: Onix" th:value="${modelo}">
                    </div>
                    <div class="col-12">
                        <label class="form-label">Ano</label>
                        <input class="form-control" type="number" name="ano" th:value="${ano}">
                    </div>

                    <div class="col-12 d-flex gap-2 mt-2">
                        <button class="btn btn-primary w-100" type="submit">Buscar</button>
                        <a class="btn btn-outline-secondary w-100" th:href="@{/pecas/estoque/consulta}">Limpar</a>
                    </div>
                </form>

                <!-- RESULTADOS (cards compactos) -->
                <div class="mt-3" th:if="${resultados != null}">
                    <div th:if="${#lists.isEmpty(resultados)}" class="alert alert-info">
                        Nenhuma pe√ßa encontrada.
                    </div>

                    <div class="d-flex flex-column gap-2" th:if="${!#lists.isEmpty(resultados)}">
                        <div class="peca-card" th:each="p : ${resultados}">
                            <div class="pc-titulo" th:text="${p.subdescricao != null ? p.subdescricao : p.descricao}">Pe√ßa</div>
                            <div class="pc-grid">
                                <div>Montadora</div><div th:text="${p.montadora}">‚Äî</div>
                                <div>Modelo</div>   <div th:text="${p.modelo}">‚Äî</div>
                                <div>Ano</div>      <div th:text="${p.ano}">‚Äî</div>
                                <div>Box</div>      <div th:text="${p.subbox != null ? p.subbox : '-'}">‚Äî</div>
                            </div>
                            <!-- A√ß√µes (mobile) -->
                            <div class="mt-2 d-flex gap-2">

                                <a href="#"
                                   class="btn btn-outline-success btn-sm w-50"
                                   data-bs-toggle="modal"
                                   data-bs-target="#modalVincular"
                                   th:attr="data-id=${p.idPeca}, data-nome=${p.subdescricao != null ? p.subdescricao : p.descricao}">
                                    <i class="bi bi-link-45deg"></i> Vincular
                                </a>

                                <a th:href="@{'/pecas/excluir/' + ${p.idPeca}}"
                                   class="btn btn-outline-danger btn-sm w-50"
                                   onclick="return confirm('Tem certeza que deseja excluir esta pe√ßa?');">
                                    <i class="bi bi-trash"></i> Excluir
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

</main>

<!-- Modal Vincular Placa -->
<div class="modal fade" id="modalVincular" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-primary">
            <form id="formVincular" method="post">
                <div class="modal-header bg-primary">
                    <h5 class="modal-title text-white">Vincular pe√ßa √† placa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Pe√ßa</label>
                        <input id="campoPeca" class="form-control" value="" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Placa</label>
                        <input class="form-control" name="placa" placeholder="ABC1D23" required>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Vincular</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Diverg√™ncia -->
<div class="modal fade" id="modalDivergencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-primary">
            <div class="modal-header bg-primary">
                <h5 class="modal-title text-white">Aten√ß√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
                <p th:text="${confirmacao}">Montadora/modelo divergentes.</p>
            </div>

            <div class="modal-footer">
                <form th:action="${confirmarVinculoLink}" method="post" class="d-inline">
                    <button type="submit" class="btn btn bg-primary text-white">Confirmar v√≠nculo</button>
                </form>

                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const existe = /*[[${confirmacao != null}]]*/ false;

        if (existe) {
            var modal = new bootstrap.Modal(document.getElementById('modalDivergencia'));
            modal.show();
        }
    });
</script>



<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById('modalVincular');
        modal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget; // bot√£o que abriu o modal
            var id = button.getAttribute('data-id');
            var nome = button.getAttribute('data-nome');

            // Preenche o nome da pe√ßa
            document.getElementById('campoPeca').value = nome || '';

            // Monta a action do form: /pecas/vincular-placa/{id}
            var form = document.getElementById('formVincular');
            form.setAttribute('action', '/pecas/vincular-placa/' + id);
        });
    });
</script>

<script>
    // Fecha os alerts automaticamente depois de 4 segundos
    document.addEventListener("DOMContentLoaded", function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 4000); // tempo em milissegundos (4000 = 4s)
        });
    });
</script>


<script th:src="@{/js/bootstrap.bundle.min.js}"></script>
</body>
</html>
